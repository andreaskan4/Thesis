@page "/settings"
@inject AuthStateService AuthStateService
@inject NavigationManager Navigation
@using Microsoft.Data.Sqlite
@using Thesis.Components.Layout
@layout MainLayout

<PageTitle>Gnosis - Settings</PageTitle>

<div class="dashboard-container">


    <!-- Main Content -->
    <div class="main-content">
        <div class="top-header">
            <div class="header-left">
                <h1>Settings</h1>
                <p class="welcome-text">Manage your preferences and system options</p>
            </div>
        </div>

        <div class="content-area">
            <!-- Notifications Section -->
            <div class="section-card">
                <div class="section-header"><h3>Notifications</h3></div>
                <div class="section-content">
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Email Notifications</h4>
                                <p>Get notified by email about important updates</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle">
                                    <input type="checkbox" @bind="emailNotifications" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Push Notifications</h4>
                                <p>Receive alerts directly in your browser or app</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle">
                                    <input type="checkbox" @bind="pushNotifications" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appearance Section -->
            <div class="section-card">
                <div class="section-header"><h3>Appearance</h3></div>
                <div class="section-content">
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Dark Mode</h4>
                                <p>Switch between light and dark theme</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle">
                                    <input type="checkbox" @bind="darkMode" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Theme</h4>
                                <p>Choose your preferred color scheme</p>
                            </div>
                            <div class="setting-control">
                                <select class="form-control" @bind="theme">
                                    <option>Light</option>
                                    <option>Ocean</option>
                                    <option>Forest</option>
                                    <option>Sunset</option>
                                </select>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <h4>Language</h4>
                                <p>Select your preferred interface language</p>
                            </div>
                            <div class="setting-control">
                                <select class="form-control" @bind="language">
                                    <option>English</option>
                                    <option>Spanish</option>
                                    <option>French</option>
                                    <option>German</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="settings-actions">
                <button class="btn btn-primary" @onclick="SaveSettings">Save Changes</button>
            </div>

            @if (!string.IsNullOrEmpty(message))
            {
                <p style="margin-top:10px;color:@(success ? "green" : "red")">@message</p>
            }
        </div>
    </div>
</div>

<!-- Logout Modal -->
@if (showLogoutModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Confirm Logout</h3></div>
            <div class="modal-body"><p>Are you sure you want to logout?</p></div>
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseLogoutModal">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmLogout">Logout</button>
            </div>
        </div>
    </div>
}

@code {
    private bool darkMode = false;
    private bool emailNotifications = true;
    private bool pushNotifications = true;
    private string theme = "Light";
    private string language = "English";
    private string message = "";
    private bool success = false;
    private bool showLogoutModal = false;

    protected override void OnInitialized()
    {
        LoadSettings();
    }

    private void LoadSettings()
    {
        try
        {
            using var conn = new SqliteConnection("Data Source=thesis.db");
            conn.Open();

            using var createCmd = conn.CreateCommand();
            createCmd.CommandText = @"CREATE TABLE IF NOT EXISTS UserSettings (
                Id INTEGER PRIMARY KEY AUTOINCREMENT,
                UserId INTEGER NOT NULL,
                DarkMode INTEGER NOT NULL DEFAULT 0,
                EmailNotifications INTEGER NOT NULL DEFAULT 1,
                PushNotifications INTEGER NOT NULL DEFAULT 1,
                Language TEXT NOT NULL DEFAULT 'English',
                Theme TEXT NOT NULL DEFAULT 'Light',
                FOREIGN KEY(UserId) REFERENCES Users(Id)
            );";
            createCmd.ExecuteNonQuery();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = "SELECT DarkMode, EmailNotifications, PushNotifications, Language, Theme FROM UserSettings WHERE UserId=@userId";
            cmd.Parameters.AddWithValue("@userId", AuthStateService.CurrentUser.Id);

            using var reader = cmd.ExecuteReader();
            if (reader.Read())
            {
                darkMode = reader.GetInt32(0) == 1;
                emailNotifications = reader.GetInt32(1) == 1;
                pushNotifications = reader.GetInt32(2) == 1;
                language = reader.GetString(3);
                theme = reader.GetString(4);
            }
            else
            {
                // Insert default settings if none exist
                using var insertCmd = conn.CreateCommand();
                insertCmd.CommandText = "INSERT INTO UserSettings (UserId) VALUES (@userId)";
                insertCmd.Parameters.AddWithValue("@userId", AuthStateService.CurrentUser.Id);
                insertCmd.ExecuteNonQuery();
            }
        }
        catch (Exception ex)
        {
            message = $"Error loading settings: {ex.Message}";
            success = false;
        }
    }

    private void SaveSettings()
    {
        try
        {
            using var conn = new SqliteConnection("Data Source=thesis.db");
            conn.Open();

            using var cmd = conn.CreateCommand();
            cmd.CommandText = @"UPDATE UserSettings
                SET DarkMode=@dark,
                    EmailNotifications=@email,
                    PushNotifications=@push,
                    Language=@lang,
                    Theme=@theme
                WHERE UserId=@userId";
            cmd.Parameters.AddWithValue("@dark", darkMode ? 1 : 0);
            cmd.Parameters.AddWithValue("@email", emailNotifications ? 1 : 0);
            cmd.Parameters.AddWithValue("@push", pushNotifications ? 1 : 0);
            cmd.Parameters.AddWithValue("@lang", language);
            cmd.Parameters.AddWithValue("@theme", theme);
            cmd.Parameters.AddWithValue("@userId", AuthStateService.CurrentUser.Id);
            cmd.ExecuteNonQuery();

            message = "Settings saved successfully!";
            success = true;
        }
        catch (Exception ex)
        {
            message = $"Error saving settings: {ex.Message}";
            success = false;
        }
    }

    private string GetUserInitials()
    {
        var name = AuthStateService.CurrentUser?.Name ?? "";
        if (string.IsNullOrEmpty(name)) return "U";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2 ? $"{parts[0][0]}{parts[1][0]}".ToUpper() : name[..1].ToUpper();
    }

    private void ShowLogoutConfirmation() => showLogoutModal = true;
    private void CloseLogoutModal() => showLogoutModal = false;
    private async Task ConfirmLogout()
    {
        await AuthStateService.LogoutAsync();
        Navigation.NavigateTo("/", true);
    }
}
<style>
    :root {
        --bg-light: #f8fafc;
        --bg-white: #ffffff;
        --bg-panel: #f1f5f9;
        --text-dark: #1e293b;
        --text-muted: #64748b;
        --primary: #3b82f6;
        --primary-light: #dbeafe;
        --success: #22c55e;
        --danger: #ef4444;
        --radius: 12px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .dashboard-container {
        display: flex;
        height: 100vh;
        background: var(--bg-light);
        overflow: hidden;
        font-family: 'Inter', sans-serif;
    }

    
    /* === MAIN CONTENT === */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 2rem;
    }

    .top-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .header-left h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .welcome-text {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }

    /* === SETTINGS CARDS === */
    .section-card {
        background: var(--bg-white);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

    .section-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 1.1rem;
    }

    .section-content {
        padding: 1.25rem 1.5rem;
    }

    /* === SETTINGS GRID === */
    .settings-grid {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f5f9;
    }

        .setting-item:last-child {
            border-bottom: none;
        }

    .setting-info h4 {
        margin: 0;
        font-size: 1rem;
        color: var(--text-dark);
    }

    .setting-info p {
        margin: 0.25rem 0 0 0;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .form-control {
        padding: 0.5rem 0.75rem;
        border-radius: var(--radius);
        border: 1px solid #d1d5db;
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s ease;
    }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

    /* === TOGGLES === */
    .toggle {
        position: relative;
        display: inline-block;
        width: 46px;
        height: 24px;
    }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.3s;
        border-radius: 24px;
    }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

    .toggle input:checked + .toggle-slider {
        background-color: var(--primary);
    }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

    /* === BUTTONS === */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius);
        border: 1px solid transparent;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

        .btn-primary:hover {
            background: #2563eb;
        }

    .btn-outline {
        background: white;
        border-color: #d1d5db;
        color: var(--text-dark);
    }

        .btn-outline:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

        .btn-danger:hover {
            background: #dc2626;
        }

    .settings-actions {
        text-align: right;
        margin-top: 1.5rem;
    }

    /* === MODAL === */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
        z-index: 50;
    }

    .modal-content {
        background: var(--bg-white);
        border-radius: var(--radius);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 420px;
        width: 90%;
        overflow: hidden;
        animation: fadeIn 0.2s ease;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: scale(0.95);
    }

    to {
        opacity: 1;
        transform: scale(1);
    }

    }

    .modal-header, .modal-footer {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-footer {
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .modal-body {
        padding: 1.5rem;
        color: var(--text-muted);
    }
</style>
